<?php

// THIS IS AUTO GENERATED SCRIPT
// (c) 2011 - <%- new Date().getFullYear()%> Andris Reinman www.pangalink.net

// STEP 1. Setup signing
// =====================

$secret = "<%- project.secret %>";

// STEP 2. Define payment information
// ==================================

<%
var fields = {};
var data = "";
-%>
$fields = array(
<% payment.fields.forEach(function(field, i){ -%>
<% fields[field.key] = field.value -%>
<% if(field.key != "SOLOPMT_MAC" && field.key != "MAC"){ -%>
        "<%- field.key %>" <%- field.key.length < 15 && new Array(15 - field.key.length).join(" ") || "" %>=> "<%- field.value.replace(/\\/g, "\\\\").replace(/"/g, "\\\"").replace(/\r/g, "\\r").replace(/\n/g, "\\n") %>"<%- i < payment.fields.length - 1  && "," || "" %>
<% } -%>
<% }) -%>
);

// STEP 3. Generate data to be signed
// ==================================
<%
    signatureOrder = signatureOrder[fields.SOLOPMT_VERSION || fields.VERSION || "0002"] || signatureOrder["0002"];
    signatureOrder = signatureOrder["PAYMENT-IN"];
-%>

<% signatureOrder.forEach(function(field, i, arr){ -%>
<% data += (fields[field] || fields["SOLOPMT_" + field] || "") + "&" -%>
<%- !i ? "$data = " : "        "%>$fields["<%- "SOLOPMT_" + field in fields ? "SOLOPMT_" + field : field %>"] . "&" .
<% })
data += project.secret + "&"
-%>
        $secret . "&";

/* $data = "<%- data.replace(/\\/g, "\\\\").replace(/"/g, "\\\"").replace(/\r/g, "\\r").replace(/\n/g, "\\n") %>"; */

// STEP 4. Sign the data with <%= project.soloAlgo.toUpperCase() %> to generate MAC code
// ========================================================

$fields["<%= "SOLOPMT_VERSION" in fields ? "SOLOPMT_" : "" %>MAC"] = strtoupper(<%= project.soloAlgo %>($data));

// STEP 5. Generate POST form with payment data that will be sent to the bank
// ==========================================================================

// Auto accept payment
// possible values: accept, cancel, reject
$fields["PANGALINK_AUTOPAY"] = "accept";

// Generate POST body from $fields
$post = array();
foreach($fields as $key=>$value){
    $post[] = "$key=" . urlencode($value);
}

$ch = curl_init("https://pangalink.net/banklink/<%- bank.key %>");
curl_setopt($ch,CURLOPT_POST, 1);
curl_setopt($ch,CURLOPT_POSTFIELDS, join("&", $post));
curl_setopt($ch,CURLOPT_FOLLOWLOCATION, 1);

//execute post
echo curl_exec($ch);

//close connection
curl_close($ch);

